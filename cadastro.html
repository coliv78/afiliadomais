<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cadastro - Minha Loja Afiliada</title>
    
    <!-- Inclui o CDN do Tailwind CSS para estilização -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Configuração do Tailwind para usar a fonte Inter e cores personalizadas -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        primary: '#4F46E5',
                        secondary: '#6B7280',
                        background: '#F9FAFB',
                        card: '#FFFFFF',
                        border: '#E5E7EB',
                    }
                }
            }
        }
    </script>
    <!-- Importa a fonte 'Inter' do Google Fonts -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    </style>
</head>
<body class="font-sans bg-background text-gray-800 antialiased">

    <!-- Cabeçalho da Página (Header) -->
    <header class="bg-primary text-white shadow-lg py-4">
        <div class="container mx-auto px-4 flex justify-between items-center">
            <h1 class="text-3xl font-bold rounded-lg p-2">Minha Loja</h1>
            <nav>
                <ul class="flex space-x-6">
                    <li><a href="index.html" class="hover:text-gray-200 transition-colors duration-300 font-medium">Início</a></li>
                    <li><a href="eletronicos.html" class="hover:text-gray-200 transition-colors duration-300 font-medium">Eletrônicos</a></li>
                    <li><a href="moda.html" class="hover:text-gray-200 transition-colors duration-300 font-medium">Moda</a></li>
                    <li><a href="casa.html" class="hover:text-gray-200 transition-colors duration-300 font-medium">Casa</a></li>
                    <li><a href="beleza.html" class="hover:text-gray-200 transition-colors duration-300 font-medium">Beleza</a></li>
                    <li><a href="esporte.html" class="hover:text-gray-200 transition-colors duration-300 font-medium">Esporte</a></li>
                    <li><a href="brinquedos.html" class="hover:text-gray-200 transition-colors duration-300 font-medium">Brinquedos</a></li>
                    <li><a href="outros.html" class="hover:text-gray-200 transition-colors duration-300 font-medium">Outros</a></li>
                    <li><a href="cadastro.html" class="hover:text-gray-200 transition-colors duration-300 font-medium">Cadastro</a></li>
                    <li><a href="politicas.html" class="hover:text-gray-200 transition-colors duration-300 font-medium">Políticas</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- Seção de Cadastro de Clientes -->
    <section class="cadastro-section bg-card py-10 px-4 shadow-md rounded-lg mx-auto mt-8 max-w-2xl">
        <div class="container mx-auto text-center">
            <h2 class="text-3xl font-bold text-gray-900 mb-8">Crie Sua Conta</h2>
            <p class="text-secondary mb-8">Preencha o formulário abaixo para se cadastrar em nossa loja.</p>

            <!-- Formulário de Cadastro -->
            <form id="cadastroForm" class="space-y-6 text-left">
                <div>
                    <label for="nome" class="block text-sm font-medium text-gray-700 mb-1">Nome Completo</label>
                    <input
                        type="text"
                        id="nome"
                        name="nome"
                        required
                        class="w-full p-3 border border-border rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-300"
                        placeholder="Seu nome completo"
                    />
                </div>
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Endereço de E-mail</label>
                    <input
                        type="email"
                        id="email"
                        name="email"
                        required
                        class="w-full p-3 border border-border rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-300"
                        placeholder="seu.email@exemplo.com"
                    />
                </div>
                <div>
                    <label for="senha" class="block text-sm font-medium text-gray-700 mb-1">Senha</label>
                    <input
                        type="password"
                        id="senha"
                        name="senha"
                        required
                        class="w-full p-3 border border-border rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-300"
                        placeholder="Mínimo 6 caracteres"
                    />
                </div>
                <div>
                    <label for="confirmar-senha" class="block text-sm font-medium text-gray-700 mb-1">Confirmar Senha</label>
                    <input
                        type="password"
                        id="confirmar-senha"
                        name="confirmar-senha"
                        required
                        class="w-full p-3 border border-border rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-300"
                        placeholder="Confirme sua senha"
                    />
                </div>
                <div>
                    <label for="telefone" class="block text-sm font-medium text-gray-700 mb-1">Telefone (Opcional)</label>
                    <input
                        type="tel"
                        id="telefone"
                        name="telefone"
                        class="w-full p-3 border border-border rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-300"
                        placeholder="(XX) XXXXX-XXXX"
                    />
                </div>
                
                <!-- Botão de Envio do Formulário -->
                <button
                    type="submit"
                    class="w-full bg-primary text-white py-3 rounded-md font-semibold hover:bg-indigo-600 transition-colors duration-300 shadow-md"
                >
                    Cadastrar
                </button>
            </form>

            <!-- Área para mensagens de feedback -->
            <div id="feedbackMessage" class="mt-4 p-3 rounded-md text-sm hidden"></div>
            <!-- Exibição do ID do Usuário para depuração -->
            <p id="userIdDisplay" class="text-xs text-gray-500 mt-4">ID do Usuário: Carregando...</p>

            <p class="text-sm text-gray-600 mt-6">Já tem uma conta? <a href="login.html" class="text-primary hover:underline">Faça login aqui</a>.</p>
        </div>
    </section>

    <!-- Rodapé da Página -->
    <footer class="bg-gray-800 text-white py-6 mt-12">
        <div class="container mx-auto px-4 text-center">
            <p class="text-sm">&copy; 2025 Minha Loja Afiliada. Todos os direitos reservados.</p>
        </div>
    </footer>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variáveis globais fornecidas pelo ambiente Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Inicializa o Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let userId = null; // Variável para armazenar o ID do usuário autenticado

        const feedbackMessageDiv = document.getElementById('feedbackMessage');
        const userIdDisplay = document.getElementById('userIdDisplay');

        // Função para exibir mensagens de feedback
        function showFeedback(message, type = 'success') {
            feedbackMessageDiv.textContent = message;
            feedbackMessageDiv.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700');
            if (type === 'success') {
                feedbackMessageDiv.classList.add('bg-green-100', 'text-green-700');
            } else {
                feedbackMessageDiv.classList.add('bg-red-100', 'text-red-700');
            }
        }

        // Autentica o usuário ao carregar a página
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                userIdDisplay.textContent = `ID do Usuário: ${userId}`;
                console.log("Usuário autenticado:", userId);
            } else {
                try {
                    if (initialAuthToken) {
                        // Tenta autenticar com o token personalizado fornecido pelo Canvas
                        await signInWithCustomToken(auth, initialAuthToken);
                        userId = auth.currentUser.uid;
                        userIdDisplay.textContent = `ID do Usuário: ${userId}`;
                        console.log("Autenticado com token personalizado:", userId);
                    } else {
                        // Se não houver token, autentica anonimamente
                        const anonymousUser = await signInAnonymously(auth);
                        userId = anonymousUser.user.uid;
                        userIdDisplay.textContent = `ID do Usuário: ${userId} (Anônimo)`;
                        console.log("Autenticado anonimamente:", userId);
                    }
                } catch (error) {
                    console.error("Erro na autenticação:", error);
                    userIdDisplay.textContent = `ID do Usuário: Erro de autenticação`;
                    showFeedback(`Erro ao autenticar: ${error.message}`, 'error');
                }
            }
        });

        // Adiciona um listener para o envio do formulário
        document.getElementById('cadastroForm').addEventListener('submit', async (e) => {
            e.preventDefault(); // Previne o comportamento padrão de recarregar a página

            // Verifica se o usuário está autenticado antes de tentar salvar
            if (!userId) {
                showFeedback("Erro: Usuário não autenticado. Tente novamente.", 'error');
                console.error("Erro: userId é nulo. Autenticação falhou ou ainda não foi concluída.");
                return;
            }

            // Coleta os dados do formulário
            const nome = document.getElementById('nome').value;
            const email = document.getElementById('email').value;
            const senha = document.getElementById('senha').value;
            const confirmarSenha = document.getElementById('confirmar-senha').value;
            const telefone = document.getElementById('telefone').value;

            // Validação básica
            if (!nome || !email || !senha || !confirmarSenha) {
                showFeedback("Por favor, preencha todos os campos obrigatórios.", 'error');
                return;
            }
            if (senha !== confirmarSenha) {
                showFeedback("As senhas não coincidem.", 'error');
                return;
            }
            if (senha.length < 6) {
                showFeedback("A senha deve ter no mínimo 6 caracteres.", 'error');
                return;
            }

            try {
                // Caminho da coleção privada para o usuário autenticado
                // /artifacts/{appId}/users/{userId}/clientes
                const clientesCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/clientes`);

                // Adiciona um novo documento à coleção 'clientes'
                await addDoc(clientesCollectionRef, {
                    nome: nome,
                    email: email,
                    // ATENÇÃO: Nunca salve senhas em texto puro no banco de dados!
                    // Em uma aplicação real, você usaria Firebase Authentication para gerenciar usuários
                    // e senhas, e não salvaria a senha diretamente no Firestore.
                    // Para este exemplo, estamos simulando o registro de dados do cliente.
                    // senha: senha, // Removido para segurança
                    telefone: telefone,
                    dataCadastro: new Date() // Adiciona um timestamp
                });

                showFeedback("Cadastro realizado com sucesso!");
                document.getElementById('cadastroForm').reset(); // Limpa o formulário
            } catch (e) {
                console.error("Erro ao adicionar documento: ", e);
                showFeedback(`Erro ao cadastrar: ${e.message}`, 'error');
            }
        });
    </script>
</body>
</html>