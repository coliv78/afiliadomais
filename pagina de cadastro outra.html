<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cadastro - Minha Loja Afiliada</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        primary: '#4F46E5',
                        secondary: '#6B7280',
                        background: '#F9FAFB',
                        card: '#FFFFFF',
                        border: '#E5E7EB',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="font-sans bg-background text-gray-800 antialiased">

    <header class="bg-primary text-white shadow-lg py-4">
        <div class="container mx-auto px-4 flex justify-between items-center">
            <h1 class="text-3xl font-bold rounded-lg p-2">Minha Loja</h1>
            <nav>
                <ul class="flex space-x-6">
                    <li><a href="index.html" class="hover:text-gray-200 transition-colors duration-300 font-medium">Início</a></li>
                    <li><a href="eletronicos.html" class="hover:text-gray-200 transition-colors duration-300 font-medium">Eletrônicos</a></li>
                    <li><a href="moda.html" class="hover:text-gray-200 transition-colors duration-300 font-medium">Moda</a></li>
                    <li><a href="casa.html" class="hover:text-gray-200 transition-colors duration-300 font-medium">Casa</a></li>
                    <li><a href="beleza.html" class="hover:text-gray-200 transition-colors duration-300 font-medium">Beleza</a></li>
                    <li><a href="esporte.html" class="hover:text-gray-200 transition-colors duration-300 font-medium">Esporte</a></li>
                    <li><a href="brinquedos.html" class="hover:text-gray-200 transition-colors duration-300 font-medium">Brinquedos</a></li>
                    <li><a href="outros.html" class="hover:text-gray-200 transition-colors duration-300 font-medium">Outros</a></li>
                    <li><a href="cadastro.html" class="hover:text-gray-200 transition-colors duration-300 font-medium">Cadastro</a></li>
                    <li><a href="politicas.html" class="hover:text-gray-200 transition-colors duration-300 font-medium">Políticas</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <section class="cadastro-section bg-card py-10 px-4 shadow-md rounded-lg mx-auto mt-8 max-w-2xl">
        <div class="container mx-auto text-center">
            <h2 class="text-3xl font-bold text-gray-900 mb-8">Crie Sua Conta</h2>
            <p class="text-secondary mb-8">Preencha o formulário abaixo para se cadastrar em nossa loja</p>
              <p class="text-secondary mb-8">e receber as atualizações de nossos produtos.(opcional).</p>
            <form id="cadastroForm" class="space-y-6 text-left">
                <div>
                    <label for="nome" class="block text-sm font-medium text-gray-700 mb-1">Nome Completo</label>
                    <input
                        type="text"
                        id="nome"
                        name="nome"
                        required
                        class="w-full p-3 border border-border rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-300"
                        placeholder="Seu nome completo"
                    />
                </div>
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Endereço de E-mail</label>
                    <input
                        type="email"
                        id="email"
                        name="email"
                        required
                        class="w-full p-3 border border-border rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-300"
                        placeholder="seu.email@exemplo.com"
                    />
                </div>
                <div>
                    <label for="senha" class="block text-sm font-medium text-gray-700 mb-1">Senha</label>
                    <input
                        type="password"
                        id="senha"
                        name="senha"
                        required
                        class="w-full p-3 border border-border rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-300"
                        placeholder="Mínimo 6 caracteres"
                    />
                </div>
                <div>
                    <label for="confirmar-senha" class="block text-sm font-medium text-gray-700 mb-1">Confirmar Senha</label>
                    <input
                        type="password"
                        id="confirmar-senha"
                        name="confirmar-senha"
                        required
                        class="w-full p-3 border border-border rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-300"
                        placeholder="Confirme sua senha"
                    />
                </div>
                <div>
                    <label for="telefone" class="block text-sm font-medium text-gray-700 mb-1">Telefone (Opcional)</label>
                    <input
                        type="tel"
                        id="telefone"
                        name="telefone"
                        class="w-full p-3 border border-border rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-300"
                        placeholder="(XX) XXXXX-XXXX"
                    />
                </div>
                
                <button
                    type="submit"
                    id="submitButton"
                    class="w-full bg-primary text-white py-3 rounded-md font-semibold hover:bg-indigo-600 transition-colors duration-300 shadow-md"
                >
                    Cadastrar
                </button>
            </form>

            <div id="feedbackMessage" class="mt-4 p-3 rounded-md text-sm hidden"></div>
            
            <p class="text-sm text-gray-600 mt-6">Já tem uma conta? <a href="login.html" class="text-primary hover:underline">Faça login aqui</a>.</p>
        </div>
    </section>

    <footer class="bg-gray-800 text-white py-6 mt-12">
        <div class="container mx-auto px-4 text-center">
            <p class="text-sm">&copy; 2025 Minha Loja Afiliada. Todos os direitos reservados.</p>
        </div>
    </footer>

    <script>
        // **Suas credenciais do Supabase**
        const SUPABASE_URL = 'https://euipmrgkumsrdumglfmx.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV1aXBtcmdrdW1zcmR1bWdsZm14Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMwODY0NTksImexdHAiOjIwNjU2NjI0NTl1.1tEJpbPxKuvo10QxLpFnOD5B0ZRKhe5Z_4RiLiWu9fM';         
        const supabase = Supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const feedbackMessageDiv = document.getElementById('feedbackMessage');
        const cadastroForm = document.getElementById('cadastroForm');
        const submitButton = document.getElementById('submitButton');

        // Função para exibir mensagens de feedback
        function showFeedback(message, type = 'success') {
            feedbackMessageDiv.textContent = message;
            feedbackMessageDiv.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700');
            if (type === 'success') {
                feedbackMessageDiv.classList.add('bg-green-100', 'text-green-700');
            } else {
                feedbackMessageDiv.classList.add('bg-red-100', 'text-red-700');
            }
            // Torna a mensagem visível
            feedbackMessageDiv.classList.remove('hidden'); 
        }

        // Adiciona um listener para o envio do formulário
        cadastroForm.addEventListener('submit', async (e) => {
            e.preventDefault(); // Previne o comportamento padrão de recarregar a página

            submitButton.disabled = true; // Desabilita o botão para evitar múltiplos cliques
            showFeedback("Processando seu cadastro...", 'info'); // Mensagem de processamento

            // Coleta os dados do formulário
            const nome = document.getElementById('nome').value.trim();
            const email = document.getElementById('email').value.trim();
            const senha = document.getElementById('senha').value.trim();
            const confirmarSenha = document.getElementById('confirmar-senha').value.trim();
            const telefone = document.getElementById('telefone').value.trim();

            // Validação básica no cliente
            if (!nome || !email || !senha || !confirmarSenha) {
                showFeedback("Por favor, preencha todos os campos obrigatórios.", 'error');
                submitButton.disabled = false;
                return;
            }
            if (senha !== confirmarSenha) {
                showFeedback("As senhas não coincidem.", 'error');
                submitButton.disabled = false;
                return;
            }
            if (senha.length < 6) {
                showFeedback("A senha deve ter no mínimo 6 caracteres.", 'error');
                submitButton.disabled = false;
                return;
            }
            // Validação de formato de e-mail básica
            if (!/\S+@\S+\.\S+/.test(email)) {
                showFeedback("Por favor, insira um endereço de e-mail válido.", "error");
                submitButton.disabled = false;
                return;
            }


            try {
                // 1. Tenta cadastrar o usuário com e-mail e senha no Supabase Auth
                const { data: authData, error: authError } = await supabase.auth.signUp({
                    email: email,
                    password: senha,
                    options: {
                        data: { // Você pode passar dados adicionais para o perfil do usuário na autenticação
                            full_name: nome // Exemplo: armazenar o nome completo no perfil de autenticação
                        }
                    }
                });

                if (authError) {
                    // Trata erros de autenticação (ex: email já cadastrado, senha fraca)
                    showFeedback(`Erro ao cadastrar: ${authError.message}`, 'error');
                    submitButton.disabled = false;
                    return;
                }

                // Supabase Auth requer confirmação de e-mail por padrão.
                // Após o registro, o usuário precisa confirmar o e-mail.
                // A `authData.user` pode ser null se a confirmação por e-mail estiver ativa.
                if (authData.user) {
                    console.log("Usuário cadastrado e logado automaticamente (se a confirmação por e-mail não estiver habilitada ou já tiver sido confirmada):", authData.user);

                    // 2. Se o cadastro de autenticação for bem-sucedido, armazena dados adicionais na tabela 'perfis_clientes'
                    // Isso é útil para informações que não são de autenticação, como telefone, endereço, etc.
                    const { data: profileData, error: profileError } = await supabase
                        .from('perfis_clientes') // Substitua pelo nome da sua tabela de perfis de cliente
                        .insert([
                            { 
                                id: authData.user.id, // O ID do perfil deve ser o mesmo ID do usuário no Supabase Auth
                                nome_completo: nome,
                                telefone: telefone,
                                email: email // Armazenar o email aqui também, se desejar facilitar consultas na tabela de perfis
                            }
                        ]);

                    if (profileError) {
                        console.error('Erro ao salvar dados do perfil:', profileError);
                        showFeedback(`Cadastro de usuário concluído, mas houve um erro ao salvar informações adicionais: ${profileError.message}`, 'error');
                        // Opcional: tentar reverter o cadastro de autenticação aqui, se a falha no perfil for crítica.
                        // (Isso é mais complexo e pode exigir funções de banco de dados ou Edge Functions)
                    } else {
                        console.log('Dados do perfil salvos com sucesso:', profileData);
                        showFeedback("Cadastro realizado com sucesso! Um e-mail de confirmação foi enviado para " + email + ". Por favor, verifique sua caixa de entrada.");
                        cadastroForm.reset(); // Limpa o formulário
                        // Redireciona para uma página de sucesso ou login após um pequeno atraso
                        setTimeout(() => {
                            window.location.href = 'login.html'; 
                        }, 3000); 
                    }
                } else {
                    // authData.user é null quando a confirmação por email está ativa e o usuário ainda não confirmou.
                    showFeedback("Cadastro realizado com sucesso! Um e-mail de confirmação foi enviado para " + email + ". Por favor, verifique sua caixa de entrada para ativar sua conta.", 'success');
                    cadastroForm.reset();
                    setTimeout(() => {
                        window.location.href = 'login.html'; 
                    }, 5000); // Dar mais tempo para o usuário ler a mensagem
                }

            } catch (e) {
                console.error("Erro inesperado durante o cadastro: ", e);
                showFeedback(`Ocorreu um erro inesperado: ${e.message}`, 'error');
            } finally {
                submitButton.disabled = false; // Habilita o botão novamente
            }
        });

        // Este trecho de código não é mais necessário, pois a autenticação anônima do Firebase
        // foi removida e o Supabase Auth gerencia o estado do usuário de forma diferente.
        // A Supabase Auth cuida da sessão do usuário automaticamente após o login/cadastro.
        /*
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                userIdDisplay.textContent = `ID do Usuário: ${userId}`;
                console.log("Usuário autenticado:", userId);
            } else {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                        userId = auth.currentUser.uid;
                        userIdDisplay.textContent = `ID do Usuário: ${userId}`;
                        console.log("Autenticado com token personalizado:", userId);
                    } else {
                        const anonymousUser = await signInAnonymously(auth);
                        userId = anonymousUser.user.uid;
                        userIdDisplay.textContent = `ID do Usuário: ${userId} (Anônimo)`;
                        console.log("Autenticado anonimamente:", userId);
                    }
                } catch (error) {
                    console.error("Erro na autenticação:", error);
                    userIdDisplay.textContent = `ID do Usuário: Erro de autenticação`;
                    showFeedback(`Erro ao autenticar: ${error.message}`, 'error');
                }
            }
        });
        */
    </script>
</body>
</html>
